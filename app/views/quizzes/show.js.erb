(function (global) {

  // add array index of for old browsers (IE<9)
  if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function(obj, start) {
      var i, j;
      i = start || 0;
      j = this.length;
      while (i < j) {
        if (this[i] === obj) {
          return i;
        }
        i++;
      }
      return -1;
    };
  }

  var QuizGenerator = {};

  var processedScripts = [];

  var styleTags = [];

  var scriptTags = document.getElementsByTagName('script');
  var thisRequestUrl = '<%= raw(request.url) %>';

  for(var i = 0; i < scriptTags.length; i++) {
    var scriptTag = scriptTags[i];

    // src matches the url of this request, and not processed it yet.
    if (scriptTag.src == thisRequestUrl && processedScripts.indexOf(scriptTag) < 0) {

      processedScripts.push(scriptTag);

      // add the style tag into the head (once only)
      if(styleTags.length == 0) {
        // add a style tag to the head
        var styleTag = document.createElement("link");
        styleTag.rel = "stylesheet";
        styleTag.type = "text/css";
        styleTag.href =  "<%= File.join(root_url, 'assets', 'embed', 'embed.css') %>";
        styleTag.media = "all";
        document.getElementsByTagName('head')[0].appendChild(styleTag);
        styleTags.push(styleTag);
      }

	    var div = document.createElement('div');
	    div.id = 'quizme_embedded_quiz';

      scriptTag.parentNode.insertBefore(div, scriptTag);
      div.innerHTML='<%= j(render("embed", quiz: @quiz)) %>';

      var embedMyQuiz = function() {
        embedQuiz('<%= raw(j @quiz.to_json(:except => [ :updated_at, :created_at, :access_count])) %>', '<%= raw(j @questions.to_json(:except => [ :updated_at, :created_at])) %>', '<%= raw(j @answers.to_json(:except => [ :updated_at, :created_at])) %>' );
      }
      var loadCustomJS = function() {
        loadScript("<%= File.join(root_url, 'assets', 'embed', 'embed.min.js') %>", embedMyQuiz);
      }

      loadScript("http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js", loadCustomJS);
      
    }
  }
})(this);

function loadScript(url, callback)
{
    // Adding the script tag to the head as suggested before
    var head = document.getElementsByTagName('head')[0];
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = url;

    // Then bind the event to the callback function.
    // There are several events for cross browser compatibility.
    script.onreadystatechange = callback;
    script.onload = callback;

    // Fire the loading
    head.appendChild(script);
}